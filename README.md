# Fathom → Pipedrive Meeting Logger

This repository contains a small Flask application that receives meeting events from Fathom (via Zapier), enriches the data, and records the activity against matching people in Pipedrive. It also persists detailed audit logs so every webhook can be reviewed later.

## How the integration works

1. **Zapier webhook** – A Zap sends the JSON payload generated by Fathom to `POST /webhook?token=<secret>`.
2. **Request validation** – The Flask route rejects the request unless the `token` query parameter matches `WEBHOOK_SECRET_TOKEN` from [`app.py`](app.py).
3. **Payload parsing** – `get_attendees_from_payload()` splits the comma‑delimited `invitees` and `invitees_email` fields into attendee records.
4. **Internal attendees skipped** – Email addresses containing `EXCLUDED_DOMAIN` are ignored so internal team members do not get duplicate notes.
5. **Pipedrive lookup** – `find_person_details_by_email()` searches the Pipedrive API for each attendee’s email address. When a person is found, the returned `id` is the Pipedrive Person ID that Zapier ultimately updates.
6. **Note creation** – `add_note_to_person()` posts a formatted HTML note containing the meeting title, attendees, and optional recording link to the matching person. If the API call fails the attempt is logged, but processing continues for the remaining attendees.
7. **Comprehensive logging** – Every webhook payload is appended to `fathom_meeting_log.jsonl`, while attendee‑level outcomes are stored in `attendee_audit_log.csv` for troubleshooting. When no attendee is found, the CSV will show `Not Found in Pipedrive` so you can decide whether to create the contact manually.
8. **Demo dashboard** – Visiting `/` renders [`templates/demo.html`](templates/demo.html), a simple UI listing all meetings received so far. This is useful for confirming the integration is receiving data from Zapier.

For ad‑hoc debugging you can run [`debug_logger.py`](debug_logger.py), which exposes a "catch‑all" Flask app that writes every incoming request—including headers and body—to `catch_all_log.txt`.

## Configuration

Update the constants at the top of [`app.py`](app.py) before deploying:

- `PIPEDRIVE_API_TOKEN` – API token for your Pipedrive account.
- `PIPEDRIVE_COMPANY_DOMAIN` – Subdomain portion of your Pipedrive instance URL.
- `WEBHOOK_SECRET_TOKEN` – Shared secret between Zapier and this service. This is validated via the `token` query parameter.
- `EXCLUDED_DOMAIN` – Email domain that should be excluded from note creation (e.g., your internal staff).
- `RAW_LOG_FILE` and `AUDIT_LOG_FILE` – File names for JSONL and CSV logs. Defaults are sufficient for most installs.

Set matching values in Zapier when configuring the webhook step so the integration can authenticate the request.

## Local development

```bash
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt  # create this from your environment or install Flask + Requests manually
python app.py
```

By default the app listens on port 5000. Use `flask run` or a tool such as `ngrok` during development if Zapier needs to reach your machine.

## Production deployment

1. Create the target directory and virtual environment on the server (e.g. `/opt/my_fathom_logger`).
2. Copy the repository contents into that directory and install the Python dependencies inside the virtual environment.
3. Drop the following unit file at `/etc/systemd/system/fathom-pipedrive.service`:

   ```ini
   [Unit]
   Description=Gunicorn instance to serve Fathom-Pipedrive integration
   After=network.target

   [Service]
   User=root
   Group=root
   WorkingDirectory=/opt/my_fathom_logger/
   Environment="PATH=/opt/my_fathom_logger/venv/bin"
   ExecStart=/opt/my_fathom_logger/venv/bin/gunicorn --workers 3 --bind 127.0.0.1:5000 app:app
   Restart=always

   [Install]
   WantedBy=multi-user.target
   ```

4. Reload and start the service:

   ```bash
   sudo systemctl daemon-reload
   sudo systemctl enable fathom-pipedrive
   sudo systemctl start fathom-pipedrive
   sudo systemctl status fathom-pipedrive  # optional health check
   ```

If you expose the app publicly (for example behind `ngrok`), confirm the forwarding service is also running (`systemctl status ngrok`).

### Current hosting caveat: temporary ngrok URL

Right now the production deployment relies on the free tier of `ngrok` to publish the Flask service to the internet. That tunnel
URL expires or stops forwarding whenever `ngrok` is restarted, so the Zapier webhook has to be updated each time with the new
address. Until we move to a permanent reverse proxy or static domain, keep the following maintenance loop in mind:

1. Restart `ngrok` if the tunnel dies.
2. Copy the new forwarding URL into the Zapier "Webhooks by Zapier" step so future Fathom events reach the app.
3. Trigger a test meeting payload and confirm it appears in the dashboard/logs.

Migrating away from ad-hoc tunnels to a stable host or DNS record will eliminate these manual updates.

## Log interpretation

- **`fathom_meeting_log.jsonl`** – Chronological history of every webhook. Each line is a JSON object containing the raw payload plus the `received_at` timestamp.
- **`attendee_audit_log.csv`** – Per-attendee audit trail. Use this to see which email addresses were matched to a Pipedrive person (`Found and Note Added`) or which still need manual follow-up (`Not Found in Pipedrive`).
- **`catch_all_log.txt`** – Populated only when `debug_logger.py` is used for troubleshooting.

You can tail the CSV/JSONL files or open them in a spreadsheet to answer questions like “which Zapier event created a note for Person ID X?” The CSV includes the Pipedrive Person ID returned by the API, linking the Zapier webhook directly to the CRM record.

## Updating Zapier

When building the Zap that sends data from Fathom:

1. Use the "Webhooks by Zapier" action in **POST** mode.
2. Set the URL to `https://<your-domain>/webhook?token=<WEBHOOK_SECRET_TOKEN>`.
3. Include the JSON body that matches the fields the app expects: `title`, `summary`, `recording_url`, `invitees`, and `invitees_email`.
4. Test the Zap and review the `/` dashboard or the log files to confirm the attendees were processed correctly.

The note text in Pipedrive is generated entirely inside this service, so no additional template logic is required in Zapier. Simply make sure the Zap passes the attendees and their emails, and the integration will take care of searching Pipedrive, adding notes, and logging the outcome for every person referenced in the event.
